# Aaron's Solace Configuration for rsyslog
# Copyright 2018
# Last tested againt rsyslogd v8.24.0

# Useful: https://docs.solace.com/System-and-Software-Maintenance/Monitoring-Events-Using-Syslog.htm

# Useful for debugging config: rsyslogd -N1 -d

# Provides TCP syslog reception
module(load="imtcp" MaxSessions="500")
input(type="imtcp" Name="SolaceDev"  Port="51400" Ruleset="sol-rsyslog" RateLimit.Interval="0" RateLimit.Burst="0")
input(type="imtcp" Name="SolaceTest" Port="51401" Ruleset="sol-rsyslog" RateLimit.Interval="0" RateLimit.Burst="0")
input(type="imtcp" Name="SolaceProd" Port="51402" Ruleset="sol-rsyslog" RateLimit.Interval="0" RateLimit.Burst="0")

# allows directories to be created with rwxr-xr-x and files with rw-r--r-- permissions
$umask 0000
$FileCreateMode 0644
$DirCreateMode 0755

# where are the Solace logs getting put?
template(name="CmdLog"    type="string" string="/var/log/solace/rsyslog/router_%HOSTNAME%/command.log")
template(name="ShowLog"   type="string" string="/var/log/solace/rsyslog/router_%HOSTNAME%/show.log")
template(name="EventLog"  type="string" string="/var/log/solace/rsyslog/router_%HOSTNAME%/event.log")
template(name="AuthLog"   type="string" string="/var/log/solace/rsyslog/router_%HOSTNAME%/auth.log")
template(name="SystemLog" type="string" string="/var/log/solace/rsyslog/router_%HOSTNAME%/system.log")
template(name="AlertLog"  type="string" string="/var/log/solace/rsyslog/alert.log")
template(name="NoticeLog" type="string" string="/var/log/solace/rsyslog/notice.log")

# Solace Command logs with ms timestamps -- have removed the severity as everything is 'info' with command logs
 template(name="CmdLogFormat" type="string" string="%TIMESTAMP:1:23:date-rfc3339%%TIMESTAMP:27:$:date-rfc3339% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n")
# millisecond timestamp format for solace event logs
#template(name="EventLogFormat" type="string" string="%TIMESTAMP:1:23:date-rfc3339%%TIMESTAMP:27:$:date-rfc3339% <%syslogfacility-text%.%syslogpriority-text%> %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n")
template(name="EventLogFormat" type="string" string="%TIMESTAMP:1:23:date-rfc3339%%TIMESTAMP:27:$:date-rfc3339% <%syslogfacility-text%.%syslogseverity-text%> %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n")
#template(name="EventLogFormat" type="string" string="%TIMESTAMP:1:23:date-rfc3339%%TIMESTAMP:27:$:date-rfc3339% <%syslogfacility-text%.%syslogseverity-text%> %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n[%msg%]\n")


ruleset (name="sol-rsyslog") {
  # command logs
  if ($syslogfacility-text == 'local1') then {
    # if they're show commands, redirect to another log
    if (($msg contains 'CLI/' and ($msg contains '> show ' or $msg contains '# show ')) or
        ($msg contains 'SEMP/' and $msg contains '  show ')) then {
      ?ShowLog; CmdLogFormat
      stop
    } else {
      # they are valid commands, so log 'em!
      ?CmdLog; CmdLogFormat
      stop
    }
  }

  # system.log  (kinda useless in my opinion, since they're a subset of event log)
  if ($syslogfacility-text == 'local4') then {
    ?SystemLog; EventLogFormat
    stop
  }

  # event log
  if ($syslogfacility-text == 'local3') then {
    # if they have annoying login/logout message generated by monitoring apps, put in another file
    if ($msg contains 'SYSTEM: SYSTEM_AUTHENTICATION_SESSION_OPENED' or
        $msg contains 'SYSTEM: SYSTEM_AUTHENTICATION_SESSION_CLOSED') then {
      ?AuthLog; EventLogFormat
      stop
    } else {
      # valid events, put in the log!
      ?EventLog; EventLogFormat
    }

#   Numerical   |   Severity
#        Code   |
#   ------------+------------------------------------------
#           0   |   Emergency: system is unusable
#           1   |   Alert: action must be taken immediately
#           2   |   Critical: critical conditions
#           3   |   Error: error conditions
#           4   |   Warning: warning conditions
#           5   |   Notice: normal but significant condition
#           6   |   Informational: informational messages
#           7   |   Debug: debug-level messages
#

    # now do some filtering and make an alertable log
    # note that the message variable actually has a space at the beginning
    #if ($msg startswith ' CLIENT: CLIENT_CLIENT_BIND_FAILED') then ~  # don't log this WARN to alert
    #if ($msg startswith ' VPN: VPN_VPN_STATE_CHANGE') then ~  # don't log this WARN to alert
    #if ($msg startswith ' VPN: VPN_SERVICE_') then ~  # ignore both VPN_SERVICE_LISTEN_PORT_STATE_CHANGE and VPN_SERVICE_SMF_STATE_CHANGE
    # for the alert.log, emit WARN or higher, and anything with CLEAR or UP, e.g. SYSTEM_HA_ACT_STATE_UP

   
    if ($msg startswith ' SYSTEM: ') then {
      # notice or higher
      if ($syslogseverity <= 5 or
          $msg contains '_CLEAR:' or
          $msg contains '_UP:') or
          $msg contains '_ENABLE:') then {
        ?AlertLog; EventLogFormat
        stop
      }
    } else {
      # these are VPN: or CLIENT: event logs
      # warning or higher
          # all SolCache events
          # all VPN bridge events
          # ignore these...
               # ignore VPn state changes
               # igore VPN_SERVICE_LISTEN_PORT_STATE_CHANGE and VPN_SERVICE_SMF_STATE_CHANGE
      if ($syslogseverity <= 4 or
          $msg contains '_CLEAR: ' or
          $msg contains '_UP: ' or
          $msg contains '_DISABLE: ' or
          $msg contains '_ENABLE: ' or
          $msg contains '_DOWN: ' or
          $msg contains 'VPN: VPN_SOLCACHE_' or
          $msg contains 'VPN: VPN_BRIDGING_LINK_' and
          not ($msg startswith 'CLIENT: CLIENT_CLIENT_BIND_FAILED: ' or
               $msg startswith 'VPN: VPN_VPN_STATE_CHANGE:' or
               $msg startswith 'VPN: VPN_SERVICE_')) then {
        ?AlertLog; EventLogFormat
        stop
      }
    }
  }
}

